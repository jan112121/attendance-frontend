<nav class="breadcrumb">
  <a routerLink="/records">Record Management</a> ‚Ä∫
  <span class="current">Student Record</span>
</nav>
<div class="master-list-container">
  <!-- HEADER -->
  <header class="header">
    <h3><mat-icon>file_upload</mat-icon> Import Master List</h3>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="fetchList()" [disabled]="loading">
        <mat-icon>refresh</mat-icon> Refresh
      </button>
      <button mat-raised-button color="warn" (click)="clearList()">
        <mat-icon>delete_sweep</mat-icon> Clear All
      </button>
    </div>
  </header>

  <!-- IMPORT SECTION -->
  <section class="import-section">
    <mat-card class="import-card">
      <p class="subtitle">You can import via JSON or upload a CSV file.</p>

      <!-- JSON IMPORT -->
      <div class="import-area">
        <textarea
          rows="5"
          [(ngModel)]="importText"
          placeholder="Paste JSON array here..."
        ></textarea>

        <button mat-raised-button color="accent" (click)="importJson()">
          <mat-icon>upload</mat-icon> Import JSON
        </button>
      </div>

      <div class="divider"><span>or</span></div>

      <!-- CSV UPLOAD -->
      <form class="csv-upload" (submit)="onUpload($event)">
        <label class="file-label" for="fileInput">
          <mat-icon>attach_file</mat-icon>
          <span>{{ selectedFile?.name || 'Choose a CSV file' }}</span>
          <input
            id="fileInput"
            type="file"
            (change)="onFileSelected($event)"
            accept=".csv"
            hidden
          />
        </label>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="!selectedFile || spinnerLoading"
        >
          <mat-icon>cloud_upload</mat-icon>
          <span *ngIf="!spinnerLoading">Upload CSV</span>
          <span *ngIf="spinnerLoading">Uploading...</span>
          <mat-spinner
            *ngIf="loading"
            diameter="20"
            color="accent"
            class="upload-spinner"
          ></mat-spinner>
        </button>
      </form>

      <p *ngIf="message" [class.success]="success" [class.error]="!success">
        {{ message }}
      </p>
    </mat-card>
  </section>

  <!-- TABLE SECTION -->
  <section class="table-section" *ngIf="!loading">
    <mat-card class="table-card">
      <div class="table-header">
        <h3>üë©‚Äçüéì Current Master List ({{ masterList.length }} Records)</h3>

        <mat-form-field appearance="outline" class="search-box">
          <mat-label>Search Students</mat-label>
          <input matInput (keyup)="applyFilter($event)" placeholder="Type to filter..." />
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="openAddStudentDialog()">
          <mat-icon>person_add</mat-icon> Add Student</button>
      </div>

      <p class="count-info">Showing {{ dataSource.data.length }} out of {{ totalItems }}</p>

      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2 styled-table">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID #</th>
            <td mat-cell *matCellDef="let s">{{ s.id }}</td>
          </ng-container>

          <ng-container matColumnDef="student_number">
            <th mat-header-cell *matHeaderCellDef>Student #</th>
            <td mat-cell *matCellDef="let s">{{ s.student_number }}</td>
          </ng-container>

          <ng-container matColumnDef="first_name">
            <th mat-header-cell *matHeaderCellDef>First Name</th>
            <td mat-cell *matCellDef="let s">{{ s.first_name }}</td>
          </ng-container>

          <ng-container matColumnDef="last_name">
            <th mat-header-cell *matHeaderCellDef>Last Name</th>
            <td mat-cell *matCellDef="let s">{{ s.last_name }}</td>
          </ng-container>

          <ng-container matColumnDef="parent_name">
            <th mat-header-cell *matHeaderCellDef>Parent Name</th>
            <td mat-cell *matCellDef="let s">{{ s.parent_name ?? '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="parent_number">
            <th mat-header-cell *matHeaderCellDef>Parent Number</th>
            <td mat-cell *matCellDef="let s">{{ s.parent_number ?? '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="parent_email">
            <th mat-header-cell *matHeaderCellDef>Parent Email</th>
            <td mat-cell *matCellDef="let s">{{ s.parent_email ?? '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="grade_level">
            <th mat-header-cell *matHeaderCellDef>Year Level</th>
            <td mat-cell *matCellDef="let s">{{ s.grade_level ?? '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="section">
            <th mat-header-cell *matHeaderCellDef>Section</th>
            <td mat-cell *matCellDef="let s">{{ s.section ?? '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="room_number">
            <th mat-header-cell *matHeaderCellDef>Room Number</th>
            <td mat-cell *matCellDef="let s">{{ s.room_number ?? '-' }}</td>
          </ng-container>

          <!-- School Level Column -->
          <ng-container matColumnDef="schoolLevel">
            <th mat-header-cell *matHeaderCellDef>School Level</th>
            <td mat-cell *matCellDef="let s">
              {{ s.schoolLevel?.level_name ?? '-' }}
            </td>
          </ng-container>

          <!-- Grade Column -->
          <ng-container matColumnDef="grade">
            <th mat-header-cell *matHeaderCellDef>Grade</th>
            <td mat-cell *matCellDef="let s">
              {{ s.grade?.grade_name ?? '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="edit_student">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let s">
              <button mat-icon-button color="accent" (click)="openEditDialog(s)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteStudent(s.id)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>

      <mat-paginator
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons
        (page)="onPageChange($event)"
      ></mat-paginator>

      <div *ngIf="masterList.length === 0" class="no-data">
        <mat-icon>info</mat-icon> No records found.
      </div>
    </mat-card>
  </section>
</div>
