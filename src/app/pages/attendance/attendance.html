<!-- ðŸ§­ Breadcrumb / Page Header -->
<nav class="breadcrumb">
  <a routerLink="/records">Attendance Management</a> â€º
  <span class="current">Attendance</span>
</nav>

<div class="attendance">
  <div class="attendance-topbar">
    <!-- Search + View Toggle -->
    <div class="topbar-left">
      <div class="search-wrapper">
        <input
          type="text"
          placeholder="Search student name or ID..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="applySearchFilter()"
        />
        <button *ngIf="searchTerm" (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="view-toggle">
        <button [class.active]="viewMode === 'today'" (click)="toggleView('today')">Today</button>
        <button [class.active]="viewMode === 'yesterday'" (click)="toggleView('yesterday')">
          Yesterday
        </button>
      </div>
    </div>

    <!-- Filters + Actions -->
    <div class="topbar-right">
      <select [(ngModel)]="selectedSession">
        <option value="">All Sessions</option>
        <option value="Morning">Morning</option>
        <option value="Afternoon">Afternoon</option>
      </select>

      <select [(ngModel)]="selectedStatus">
        <option value="">All Status</option>
        <option value="present">Present</option>
        <option value="late">Late</option>
        <option value="absent">Absent</option>
        <option value="Excused">Excused</option>
      </select>

      <input type="date" [(ngModel)]="selectedDate" placeholder="Select date" />

      <div class="filter-actions">
        <button class="btn-apply" (click)="applyFilters()">
          <mat-icon>filter_alt</mat-icon>
          Apply
        </button>
        <button class="btn-reset" (click)="resetFilter()">
          <mat-icon>refresh</mat-icon>
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- ðŸ”¹ Global Empty State -->
  <div
    *ngIf="!loading && !morningDataSource.data.length && !afternoonDataSource.data.length"
    class="no-data-global"
  >
    <p>No attendance records found for the selected date or session.</p>
  </div>
  <!-- ðŸ”¹ Tabs for Sessions -->
  <mat-tab-group>
    <!-- Morning Session -->
    <mat-tab label="â˜€ï¸ Morning Session">
      <section class="card">
        <ng-container *ngIf="morningDataSource.data.length > 0; else morningEmpty">
          <table mat-table [dataSource]="morningDataSource" class="attendance-table">
            <!-- Name -->
            <ng-container matColumnDef="first_name">
              <th mat-header-cell *matHeaderCellDef>First Name</th>
              <td mat-cell *matCellDef="let record">{{ record.User?.first_name || '-' }}</td>
            </ng-container>

                      <ng-container matColumnDef="last_name">
              <th mat-header-cell *matHeaderCellDef>Last Name</th>
              <td mat-cell *matCellDef="let record">{{ record.User?.last_name || '-' }}</td>
            </ng-container>

            <!-- Section -->
            <ng-container matColumnDef="section">
              <th mat-header-cell *matHeaderCellDef>Section</th>
              <td mat-cell *matCellDef="let record">{{ record.User?.master?.section || '-' }}</td>
            </ng-container>

            <!-- Time In -->
            <ng-container matColumnDef="time">
              <th mat-header-cell *matHeaderCellDef>Time In</th>
              <td mat-cell *matCellDef="let record">{{ formatTime(record.time) }}</td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td
                mat-cell
                *matCellDef="let record"
                class="status-cell"
                [ngClass]="record.status?.toLowerCase()"
              >
                {{ record.status | titlecase }}
              </td>
            </ng-container>

            <!-- Time Out -->
            <ng-container matColumnDef="time_out">
              <th mat-header-cell *matHeaderCellDef>Time Out</th>
              <td mat-cell *matCellDef="let record">{{ formatTime(record.time_out) }}</td>
            </ng-container>

            <!-- Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <mat-paginator
            #morningPaginator
            [pageSize]="10"
            [pageSizeOptions]="[10, 25, 50, 100]"
            showFirstLastButtons
          ></mat-paginator>
        </ng-container>

        <ng-template #morningEmpty>
          <p class="no-data">No attendance records for the morning session.</p>
        </ng-template>
      </section>
    </mat-tab>

    <!-- Afternoon Session -->
    <mat-tab label="ðŸŒ¤ Afternoon Session">
      <section class="card">
        <ng-container *ngIf="afternoonDataSource.data.length > 0; else afternoonEmpty">
          <table mat-table [dataSource]="afternoonDataSource" class="attendance-table">
            <!-- Columns same as Morning -->
            <ng-container matColumnDef="first_name">
              <th mat-header-cell *matHeaderCellDef>First Name</th>
              <td mat-cell *matCellDef="let record">{{ record.User?.first_name || '-' }}</td>
            </ng-container>
            <ng-container matColumnDef="last_name">
              <th mat-header-cell *matHeaderCellDef>Last Name</th>
              <td mat-cell *matCellDef="let record">{{ record.User?.last_name || '-' }}</td>
            </ng-container>
            <ng-container matColumnDef="section">
              <th mat-header-cell *matHeaderCellDef>Section</th>
              <td mat-cell *matCellDef="let record">{{ record.User?.master?.section || '-' }}</td>
            </ng-container>
            <ng-container matColumnDef="time">
              <th mat-header-cell *matHeaderCellDef>Time In</th>
              <td mat-cell *matCellDef="let record">{{ formatTime(record.time) }}</td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td
                mat-cell
                *matCellDef="let record"
                class="status-cell"
                [ngClass]="record.status?.toLowerCase()"
              >
                {{ record.status | titlecase }}
              </td>
            </ng-container>
            <ng-container matColumnDef="time_out">
              <th mat-header-cell *matHeaderCellDef>Time Out</th>
              <td mat-cell *matCellDef="let record">{{ formatTime(record.time_out) }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <mat-paginator
            #afternoonPaginator
            [pageSize]="50"
            [pageSizeOptions]="[10, 25, 50, 100]"
            showFirstLastButtons
          ></mat-paginator>
        </ng-container>

        <ng-template #afternoonEmpty>
          <p class="no-data">No attendance records for the afternoon session.</p>
        </ng-template>
      </section>
    </mat-tab>
  </mat-tab-group>

  <!-- ðŸ”¹ Loading -->
  <div *ngIf="loading" class="loading">Loading attendance...</div>
</div>
